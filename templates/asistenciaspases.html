<form id="frmAsistenciasPase" method="post">
    <input type="hidden" id="idAsistenciaPase" name="idAsistenciaPase">
    <div class="mb-1">
        <label for="selIdEmpleado">Empleado</label>
        <select class="form-select" id="selIdEmpleado" name="idEmpleado" required>
            <option value="" selected disabled>-- Selecciona un Empleado --</option>
            {% for empleado in empleados %}
            <option value="{{ empleado.idEmpleado }}">{{ empleado.nombreEmpleado }}</option>
            {% endfor %}
        </select>
    </div>
    
    <div class="mb-1">
        <label for="selIdAsistencia">Fecha de Asistencia</label>
        <select class="form-select" id="selIdAsistencia" name="idAsistencia" required>
            <option value="" selected disabled>-- Selecciona una Fecha de Asistencia --</option>
            {% for asistencia in asistencias %}
            <option value="{{ asistencia.idAsistencia }}">{{ asistencia.fecha }} - ({{ asistencia.comentarios }})</option>
            {% endfor %}
        </select>
    </div>

    <div class="form-group col-md-4">
        <label for="selEstado">Estado</label>
        <select class="form-control" id="selEstado" name="selEstado" required>
            <option value="" disabled selected>-- Seleccione un Estado --</option>
            <option value="Asistencia">Asistencia</option>
            <option value="Retardo">Retardo</option>
            <option value="Falta">Falta</option>
        </select>
    </div>
    
    <div class="mb-1 text-end">
        <button class="btn btn-primary">Guardar</button>
    </div>
</form>

<form id="frmBusqueda" class="mb-3">
    <div class="input-group">
        <input type="text" id="txtBusqueda" class="form-control" placeholder="Buscar por nombre de empleado...">
        <button class="btn btn-outline-secondary" type="submit">Buscar</button>
    </div>
</form>

<div class="table-responsive">
    <table class="table table-sm">
        <thead class="table-active">
            <tr>
                <th>ID Asistencia Pase</th>
                <th>Empleado</th>
                <th>Asistencia</th>
                <th>Estado</th>
                <th></th>
            </tr>
        </thead>
        <tbody id="tbodyAsistenciasPases"></tbody>
    </table>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const tbody = document.getElementById('tbodyAsistenciasPases');

        // Función para cargar la tabla (con o sin filtro de búsqueda)
        function cargarTabla(busqueda = '') {
            const url = busqueda ? `/tbodyAsistenciasPases?busqueda=${encodeURIComponent(busqueda)}` : '/tbodyAsistenciasPases';
            fetch(url)
                .then(response => response.text())
                .then(html => {
                    tbody.innerHTML = html;
                })
                .catch(error => console.warn('Error al cargar la tabla:', error));
        }

        // Carga inicial de la tabla
        cargarTabla();

        // Event Listener para el formulario de búsqueda
        document.getElementById('frmBusqueda').addEventListener('submit', function (e) {
            e.preventDefault();
            const busqueda = document.getElementById('txtBusqueda').value;
            cargarTabla(busqueda);
        });

        // Event delegation para los botones de eliminar
        tbody.addEventListener('click', function (e) {
            if (e.target.classList.contains('btn-eliminar-pase')) {
                const id = e.target.dataset.id;
                
                if (confirm('¿Estás seguro de que deseas eliminar este registro?')) {
                    fetch(`/asistenciapase/${id}`, {
                        method: 'DELETE',
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.message) {
                            console.log(data.message);
                            // Recargamos la tabla para que se reflejen los cambios
                            cargarTabla(document.getElementById('txtBusqueda').value); 
                        } else {
                            console.error(data.error);
                            alert('Error al eliminar el registro.');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Ocurrió un error en la comunicación con el servidor.');
                    });
                }
            }
        });
    });
</script>
